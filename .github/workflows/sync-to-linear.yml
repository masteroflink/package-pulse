name: Sync GitHub to Linear

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

permissions:
  issues: write

jobs:
  create-linear-issue:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Create Linear Issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.issue.title;
            const body = context.payload.issue.body || '';
            const githubUrl = context.payload.issue.html_url;
            const issueNumber = context.payload.issue.number;

            // Get labels and ensure they exist in Linear
            const labels = context.payload.issue.labels || [];
            const labelIds = [];

            // Process labels sequentially to avoid race conditions
            for (const label of labels) {
              console.log(`Processing label: ${label.name}`);

              const searchQuery = `{
                issueLabels(filter: { name: { eq: "${label.name}" } }) {
                  nodes { id name }
                }
              }`;

              const searchResponse = await fetch('https://api.linear.app/graphql', {
                method: 'POST',
                headers: {
                  'Authorization': process.env.LINEAR_API_KEY,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: searchQuery })
              });

              const searchResult = await searchResponse.json();
              console.log(`Search result for ${label.name}:`, JSON.stringify(searchResult));

              if (searchResult.data?.issueLabels?.nodes?.length > 0) {
                const labelId = searchResult.data.issueLabels.nodes[0].id;
                labelIds.push(labelId);
                console.log(`Found existing label ${label.name} with ID: ${labelId}`);
              } else {
                const color = label.color ? `#${label.color}` : '#888888';
                const createLabelQuery = `
                  mutation {
                    issueLabelCreate(input: {
                      teamId: "${process.env.LINEAR_TEAM_ID}"
                      name: "${label.name}"
                      color: "${color}"
                    }) {
                      success
                      issueLabel { id }
                    }
                  }
                `;

                const createResponse = await fetch('https://api.linear.app/graphql', {
                  method: 'POST',
                  headers: {
                    'Authorization': process.env.LINEAR_API_KEY,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ query: createLabelQuery })
                });

                const createResult = await createResponse.json();
                console.log(`Create label result for ${label.name}:`, JSON.stringify(createResult));

                if (createResult.data?.issueLabelCreate?.success) {
                  const labelId = createResult.data.issueLabelCreate.issueLabel.id;
                  labelIds.push(labelId);
                  console.log(`Created label ${label.name} with ID: ${labelId}`);
                } else {
                  console.error(`Failed to create label ${label.name}`);
                }
              }
            }

            console.log(`Final labelIds array: ${JSON.stringify(labelIds)}`);

            // Build input object
            const input = {
              teamId: process.env.LINEAR_TEAM_ID,
              projectId: process.env.LINEAR_PROJECT_ID,
              title: title,
              description: `${body}\n\n---\n[GitHub Issue #${issueNumber}](${githubUrl})`
            };

            if (labelIds.length > 0) {
              input.labelIds = labelIds;
            }

            console.log(`Creating Linear issue with input:`, JSON.stringify(input));

            const createQuery = `
              mutation CreateIssue($input: IssueCreateInput!) {
                issueCreate(input: $input) {
                  success
                  issue {
                    id
                    identifier
                    url
                  }
                }
              }
            `;

            const response = await fetch('https://api.linear.app/graphql', {
              method: 'POST',
              headers: {
                'Authorization': process.env.LINEAR_API_KEY,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ query: createQuery, variables: { input } })
            });

            const result = await response.json();
            console.log(`Create issue result:`, JSON.stringify(result));

            if (result.data?.issueCreate?.success) {
              const issue = result.data.issueCreate.issue;
              console.log(`Created Linear issue: ${issue.identifier}`);
            } else {
              console.error('Failed to create Linear issue:', JSON.stringify(result, null, 2));
              core.setFailed('Failed to create Linear issue');
            }
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_TEAM_ID: ${{ secrets.LINEAR_TEAM_ID }}
          LINEAR_PROJECT_ID: ${{ secrets.LINEAR_PROJECT_ID }}

  sync-label-to-linear:
    if: github.event_name == 'issues' && github.event.action == 'labeled'
    runs-on: ubuntu-latest
    steps:
      - name: Sync Label to Linear
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            const label = context.payload.label;

            console.log(`Syncing label ${label.name} for issue #${issueNumber}`);

            // Find linked Linear issue
            const searchQuery = `{
              issues(filter: { description: { contains: "GitHub Issue #${issueNumber}]" } }) {
                nodes { id identifier }
              }
            }`;

            const searchResponse = await fetch('https://api.linear.app/graphql', {
              method: 'POST',
              headers: {
                'Authorization': process.env.LINEAR_API_KEY,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ query: searchQuery })
            });

            const searchResult = await searchResponse.json();
            const linearIssue = searchResult.data?.issues?.nodes?.[0];

            if (!linearIssue) {
              console.log('No linked Linear issue found');
              return;
            }

            console.log(`Found linked Linear issue: ${linearIssue.identifier}`);

            // Find or create the label
            const labelSearchQuery = `{
              issueLabels(filter: { name: { eq: "${label.name}" } }) {
                nodes { id }
              }
            }`;

            const labelSearchResponse = await fetch('https://api.linear.app/graphql', {
              method: 'POST',
              headers: {
                'Authorization': process.env.LINEAR_API_KEY,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ query: labelSearchQuery })
            });

            const labelSearchResult = await labelSearchResponse.json();
            let labelId;

            if (labelSearchResult.data?.issueLabels?.nodes?.length > 0) {
              labelId = labelSearchResult.data.issueLabels.nodes[0].id;
              console.log(`Found existing label with ID: ${labelId}`);
            } else {
              const color = label.color ? `#${label.color}` : '#888888';
              const createLabelQuery = `
                mutation {
                  issueLabelCreate(input: {
                    teamId: "${process.env.LINEAR_TEAM_ID}"
                    name: "${label.name}"
                    color: "${color}"
                  }) {
                    success
                    issueLabel { id }
                  }
                }
              `;

              const createResponse = await fetch('https://api.linear.app/graphql', {
                method: 'POST',
                headers: {
                  'Authorization': process.env.LINEAR_API_KEY,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: createLabelQuery })
              });

              const createResult = await createResponse.json();
              labelId = createResult.data?.issueLabelCreate?.issueLabel?.id;
              console.log(`Created label with ID: ${labelId}`);
            }

            if (labelId) {
              const addLabelQuery = `
                mutation {
                  issueAddLabel(id: "${linearIssue.id}", labelId: "${labelId}") {
                    success
                  }
                }
              `;

              const addResponse = await fetch('https://api.linear.app/graphql', {
                method: 'POST',
                headers: {
                  'Authorization': process.env.LINEAR_API_KEY,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: addLabelQuery })
              });

              const addResult = await addResponse.json();
              console.log(`Add label result:`, JSON.stringify(addResult));
            }
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_TEAM_ID: ${{ secrets.LINEAR_TEAM_ID }}

  sync-comment-to-linear:
    if: github.event_name == 'issue_comment' && github.event.action == 'created'
    runs-on: ubuntu-latest
    steps:
      - name: Sync Comment to Linear
        uses: actions/github-script@v7
        with:
          script: |
            // Skip bot comments
            if (context.payload.comment.user.type === 'Bot') {
              console.log('Skipping bot comment');
              return;
            }

            const issueNumber = context.payload.issue.number;
            const commentBody = context.payload.comment.body;
            const commenter = context.payload.comment.user.login;

            // Find linked Linear issue
            const searchQuery = `{
              issues(filter: { description: { contains: "GitHub Issue #${issueNumber}]" } }) {
                nodes { id identifier }
              }
            }`;

            const searchResponse = await fetch('https://api.linear.app/graphql', {
              method: 'POST',
              headers: {
                'Authorization': process.env.LINEAR_API_KEY,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ query: searchQuery })
            });

            const searchResult = await searchResponse.json();
            const linearIssue = searchResult.data?.issues?.nodes?.[0];

            if (!linearIssue) {
              console.log('No linked Linear issue found');
              return;
            }

            // Create comment using variables to handle escaping
            const createCommentQuery = `
              mutation CreateComment($input: CommentCreateInput!) {
                commentCreate(input: $input) {
                  success
                }
              }
            `;

            const response = await fetch('https://api.linear.app/graphql', {
              method: 'POST',
              headers: {
                'Authorization': process.env.LINEAR_API_KEY,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                query: createCommentQuery,
                variables: {
                  input: {
                    issueId: linearIssue.id,
                    body: `**From GitHub - @${commenter}**\n\n${commentBody}`
                  }
                }
              })
            });

            const result = await response.json();
            console.log(`Comment synced to ${linearIssue.identifier}`);
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
