name: Sync GitHub to Linear

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

jobs:
  create-linear-issue:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Create Linear Issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.issue.title;
            const body = context.payload.issue.body || '';
            const githubUrl = context.payload.issue.html_url;
            const issueNumber = context.payload.issue.number;

            const labels = context.payload.issue.labels || [];
            const labelIds = [];

            for (const label of labels) {
              console.log(`Processing label: ${label.name}`);

              try {
                // Search for label within the team
                const searchQuery = `{
                  team(id: "${process.env.LINEAR_TEAM_ID}") {
                    labels(filter: { name: { eq: "${label.name}" } }) {
                      nodes { id name }
                    }
                  }
                }`;

                const searchResponse = await fetch('https://api.linear.app/graphql', {
                  method: 'POST',
                  headers: {
                    'Authorization': process.env.LINEAR_API_KEY,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ query: searchQuery })
                });

                if (!searchResponse.ok) {
                  console.error(`Team label search HTTP error: ${searchResponse.status} ${searchResponse.statusText}`);
                  const text = await searchResponse.text();
                  console.error(`Response body: ${text}`);
                  continue;
                }

                const searchResult = await searchResponse.json();
                console.log(`Team label search result for ${label.name}:`, JSON.stringify(searchResult, null, 2));

                if (searchResult.errors) {
                  console.error(`GraphQL errors in team search:`, JSON.stringify(searchResult.errors, null, 2));
                }

                if (searchResult.data?.team?.labels?.nodes?.length > 0) {
                  const labelId = searchResult.data.team.labels.nodes[0].id;
                  labelIds.push(labelId);
                  console.log(`Found existing team label ${label.name} with ID: ${labelId}`);
                  continue;
                }

                // Check workspace-level labels
                const workspaceQuery = `{
                  issueLabels(filter: { name: { eq: "${label.name}" } }) {
                    nodes { id name }
                  }
                }`;

                const wsResponse = await fetch('https://api.linear.app/graphql', {
                  method: 'POST',
                  headers: {
                    'Authorization': process.env.LINEAR_API_KEY,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ query: workspaceQuery })
                });

                if (!wsResponse.ok) {
                  console.error(`Workspace label search HTTP error: ${wsResponse.status} ${wsResponse.statusText}`);
                  const text = await wsResponse.text();
                  console.error(`Response body: ${text}`);
                  continue;
                }

                const wsResult = await wsResponse.json();
                console.log(`Workspace label search result for ${label.name}:`, JSON.stringify(wsResult, null, 2));

                if (wsResult.errors) {
                  console.error(`GraphQL errors in workspace search:`, JSON.stringify(wsResult.errors, null, 2));
                }

                if (wsResult.data?.issueLabels?.nodes?.length > 0) {
                  const labelId = wsResult.data.issueLabels.nodes[0].id;
                  labelIds.push(labelId);
                  console.log(`Found existing workspace label ${label.name} with ID: ${labelId}`);
                  continue;
                }

                // Create the label
                console.log(`Label ${label.name} not found, creating...`);
                const color = label.color ? `#${label.color}` : '#888888';
                const createLabelQuery = `
                  mutation {
                    issueLabelCreate(input: {
                      teamId: "${process.env.LINEAR_TEAM_ID}"
                      name: "${label.name}"
                      color: "${color}"
                    }) {
                      success
                      issueLabel { id name }
                    }
                  }
                `;

                const createResponse = await fetch('https://api.linear.app/graphql', {
                  method: 'POST',
                  headers: {
                    'Authorization': process.env.LINEAR_API_KEY,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ query: createLabelQuery })
                });

                if (!createResponse.ok) {
                  console.error(`Create label HTTP error: ${createResponse.status} ${createResponse.statusText}`);
                  const text = await createResponse.text();
                  console.error(`Response body: ${text}`);
                  continue;
                }

                const createResult = await createResponse.json();
                console.log(`Create label result for ${label.name}:`, JSON.stringify(createResult, null, 2));

                if (createResult.errors) {
                  console.error(`GraphQL errors creating label:`, JSON.stringify(createResult.errors, null, 2));
                }

                if (createResult.data?.issueLabelCreate?.success) {
                  const labelId = createResult.data.issueLabelCreate.issueLabel.id;
                  labelIds.push(labelId);
                  console.log(`Created label ${label.name} with ID: ${labelId}`);
                } else {
                  console.error(`Failed to create label ${label.name}. Success: ${createResult.data?.issueLabelCreate?.success}`);
                }

              } catch (error) {
                console.error(`Exception processing label ${label.name}:`, error.message);
                console.error(error.stack);
              }
            }

            console.log(`Final labelIds array: ${JSON.stringify(labelIds)}`);

            const input = {
              teamId: process.env.LINEAR_TEAM_ID,
              projectId: process.env.LINEAR_PROJECT_ID,
              title: title,
              description: `${body}\n\n---\n[GitHub Issue #${issueNumber}](${githubUrl})`
            };

            if (labelIds.length > 0) {
              input.labelIds = labelIds;
            }

            console.log(`Creating Linear issue with input:`, JSON.stringify(input, null, 2));

            try {
              const createQuery = `
                mutation CreateIssue($input: IssueCreateInput!) {
                  issueCreate(input: $input) {
                    success
                    issue {
                      id
                      identifier
                      url
                    }
                  }
                }
              `;

              const response = await fetch('https://api.linear.app/graphql', {
                method: 'POST',
                headers: {
                  'Authorization': process.env.LINEAR_API_KEY,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: createQuery, variables: { input } })
              });

              if (!response.ok) {
                console.error(`Create issue HTTP error: ${response.status} ${response.statusText}`);
                const text = await response.text();
                console.error(`Response body: ${text}`);
                core.setFailed('HTTP error creating Linear issue');
                return;
              }

              const result = await response.json();
              console.log(`Create issue result:`, JSON.stringify(result, null, 2));

              if (result.errors) {
                console.error(`GraphQL errors:`, JSON.stringify(result.errors, null, 2));
                core.setFailed('GraphQL error creating Linear issue');
                return;
              }

              if (result.data?.issueCreate?.success) {
                const issue = result.data.issueCreate.issue;
                console.log(`Successfully created Linear issue: ${issue.identifier} - ${issue.url}`);
              } else {
                console.error(`issueCreate returned success: false`);
                core.setFailed('Failed to create Linear issue');
              }

            } catch (error) {
              console.error(`Exception creating issue:`, error.message);
              console.error(error.stack);
              core.setFailed(`Exception: ${error.message}`);
            }
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_TEAM_ID: ${{ secrets.LINEAR_TEAM_ID }}
          LINEAR_PROJECT_ID: ${{ secrets.LINEAR_PROJECT_ID }}

  sync-label-to-linear:
    if: github.event_name == 'issues' && github.event.action == 'labeled'
    runs-on: ubuntu-latest
    steps:
      - name: Sync Label to Linear
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            const label = context.payload.label;

            console.log(`Syncing label "${label.name}" for issue #${issueNumber}`);
            console.log(`Label details:`, JSON.stringify(label, null, 2));

            try {
              // Find linked Linear issue
              const searchQuery = `{
                issues(filter: { description: { contains: "GitHub Issue #${issueNumber}]" } }) {
                  nodes { id identifier }
                }
              }`;

              const searchResponse = await fetch('https://api.linear.app/graphql', {
                method: 'POST',
                headers: {
                  'Authorization': process.env.LINEAR_API_KEY,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: searchQuery })
              });

              if (!searchResponse.ok) {
                console.error(`Issue search HTTP error: ${searchResponse.status} ${searchResponse.statusText}`);
                const text = await searchResponse.text();
                console.error(`Response body: ${text}`);
                return;
              }

              const searchResult = await searchResponse.json();
              console.log(`Issue search result:`, JSON.stringify(searchResult, null, 2));

              if (searchResult.errors) {
                console.error(`GraphQL errors:`, JSON.stringify(searchResult.errors, null, 2));
              }

              const linearIssue = searchResult.data?.issues?.nodes?.[0];

              if (!linearIssue) {
                console.log('No linked Linear issue found');
                return;
              }

              console.log(`Found linked Linear issue: ${linearIssue.identifier}`);

              // Search for label in team
              const teamLabelQuery = `{
                team(id: "${process.env.LINEAR_TEAM_ID}") {
                  labels(filter: { name: { eq: "${label.name}" } }) {
                    nodes { id name }
                  }
                }
              }`;

              const teamLabelResponse = await fetch('https://api.linear.app/graphql', {
                method: 'POST',
                headers: {
                  'Authorization': process.env.LINEAR_API_KEY,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: teamLabelQuery })
              });

              if (!teamLabelResponse.ok) {
                console.error(`Team label search HTTP error: ${teamLabelResponse.status} ${teamLabelResponse.statusText}`);
                const text = await teamLabelResponse.text();
                console.error(`Response body: ${text}`);
                return;
              }

              const teamLabelResult = await teamLabelResponse.json();
              console.log(`Team label search result:`, JSON.stringify(teamLabelResult, null, 2));

              if (teamLabelResult.errors) {
                console.error(`GraphQL errors:`, JSON.stringify(teamLabelResult.errors, null, 2));
              }

              let labelId;

              if (teamLabelResult.data?.team?.labels?.nodes?.length > 0) {
                labelId = teamLabelResult.data.team.labels.nodes[0].id;
                console.log(`Found team label with ID: ${labelId}`);
              } else {
                // Check workspace-level labels
                const workspaceLabelQuery = `{
                  issueLabels(filter: { name: { eq: "${label.name}" } }) {
                    nodes { id name }
                  }
                }`;

                const wsResponse = await fetch('https://api.linear.app/graphql', {
                  method: 'POST',
                  headers: {
                    'Authorization': process.env.LINEAR_API_KEY,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ query: workspaceLabelQuery })
                });

                if (!wsResponse.ok) {
                  console.error(`Workspace label search HTTP error: ${wsResponse.status} ${wsResponse.statusText}`);
                  const text = await wsResponse.text();
                  console.error(`Response body: ${text}`);
                  return;
                }

                const wsResult = await wsResponse.json();
                console.log(`Workspace label search result:`, JSON.stringify(wsResult, null, 2));

                if (wsResult.errors) {
                  console.error(`GraphQL errors:`, JSON.stringify(wsResult.errors, null, 2));
                }

                if (wsResult.data?.issueLabels?.nodes?.length > 0) {
                  labelId = wsResult.data.issueLabels.nodes[0].id;
                  console.log(`Found workspace label with ID: ${labelId}`);
                } else {
                  // Create the label
                  console.log(`Label "${label.name}" not found, creating...`);
                  const color = label.color ? `#${label.color}` : '#888888';

                  const createLabelQuery = `
                    mutation {
                      issueLabelCreate(input: {
                        teamId: "${process.env.LINEAR_TEAM_ID}"
                        name: "${label.name}"
                        color: "${color}"
                      }) {
                        success
                        issueLabel { id name }
                      }
                    }
                  `;

                  const createResponse = await fetch('https://api.linear.app/graphql', {
                    method: 'POST',
                    headers: {
                      'Authorization': process.env.LINEAR_API_KEY,
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: createLabelQuery })
                  });

                  if (!createResponse.ok) {
                    console.error(`Create label HTTP error: ${createResponse.status} ${createResponse.statusText}`);
                    const text = await createResponse.text();
                    console.error(`Response body: ${text}`);
                    return;
                  }

                  const createResult = await createResponse.json();
                  console.log(`Create label result:`, JSON.stringify(createResult, null, 2));

                  if (createResult.errors) {
                    console.error(`GraphQL errors creating label:`, JSON.stringify(createResult.errors, null, 2));
                  }

                  if (createResult.data?.issueLabelCreate?.success) {
                    labelId = createResult.data.issueLabelCreate.issueLabel.id;
                    console.log(`Created label with ID: ${labelId}`);
                  } else {
                    console.error(`Failed to create label. Full response:`, JSON.stringify(createResult, null, 2));
                    return;
                  }
                }
              }

              if (labelId) {
                console.log(`Adding label ${labelId} to issue ${linearIssue.id}`);

                const addLabelQuery = `
                  mutation {
                    issueAddLabel(id: "${linearIssue.id}", labelId: "${labelId}") {
                      success
                    }
                  }
                `;

                const addResponse = await fetch('https://api.linear.app/graphql', {
                  method: 'POST',
                  headers: {
                    'Authorization': process.env.LINEAR_API_KEY,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ query: addLabelQuery })
                });

                if (!addResponse.ok) {
                  console.error(`Add label HTTP error: ${addResponse.status} ${addResponse.statusText}`);
                  const text = await addResponse.text();
                  console.error(`Response body: ${text}`);
                  return;
                }

                const addResult = await addResponse.json();
                console.log(`Add label result:`, JSON.stringify(addResult, null, 2));

                if (addResult.errors) {
                  console.error(`GraphQL errors adding label:`, JSON.stringify(addResult.errors, null, 2));
                }

                if (addResult.data?.issueAddLabel?.success) {
                  console.log(`Successfully added label "${label.name}" to ${linearIssue.identifier}`);
                } else {
                  console.error(`Failed to add label. Success: ${addResult.data?.issueAddLabel?.success}`);
                }
              } else {
                console.error(`Could not find or create label: ${label.name}`);
              }

            } catch (error) {
              console.error(`Exception:`, error.message);
              console.error(error.stack);
            }
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_TEAM_ID: ${{ secrets.LINEAR_TEAM_ID }}

  sync-comment-to-linear:
    if: github.event_name == 'issue_comment' && github.event.action == 'created'
    runs-on: ubuntu-latest
    steps:
      - name: Sync Comment to Linear
        uses: actions/github-script@v7
        with:
          script: |
            if (context.payload.comment.user.type === 'Bot') {
              console.log('Skipping bot comment');
              return;
            }

            const issueNumber = context.payload.issue.number;
            const commentBody = context.payload.comment.body;
            const commenter = context.payload.comment.user.login;

            console.log(`Syncing comment from @${commenter} on issue #${issueNumber}`);

            try {
              const searchQuery = `{
                issues(filter: { description: { contains: "GitHub Issue #${issueNumber}]" } }) {
                  nodes { id identifier }
                }
              }`;

              const searchResponse = await fetch('https://api.linear.app/graphql', {
                method: 'POST',
                headers: {
                  'Authorization': process.env.LINEAR_API_KEY,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: searchQuery })
              });

              if (!searchResponse.ok) {
                console.error(`Issue search HTTP error: ${searchResponse.status} ${searchResponse.statusText}`);
                const text = await searchResponse.text();
                console.error(`Response body: ${text}`);
                return;
              }

              const searchResult = await searchResponse.json();
              console.log(`Issue search result:`, JSON.stringify(searchResult, null, 2));

              if (searchResult.errors) {
                console.error(`GraphQL errors:`, JSON.stringify(searchResult.errors, null, 2));
              }

              const linearIssue = searchResult.data?.issues?.nodes?.[0];

              if (!linearIssue) {
                console.log('No linked Linear issue found');
                return;
              }

              console.log(`Found linked Linear issue: ${linearIssue.identifier}`);

              const createCommentQuery = `
                mutation CreateComment($input: CommentCreateInput!) {
                  commentCreate(input: $input) {
                    success
                    comment { id }
                  }
                }
              `;

              const response = await fetch('https://api.linear.app/graphql', {
                method: 'POST',
                headers: {
                  'Authorization': process.env.LINEAR_API_KEY,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  query: createCommentQuery,
                  variables: {
                    input: {
                      issueId: linearIssue.id,
                      body: `**From GitHub - @${commenter}**\n\n${commentBody}`
                    }
                  }
                })
              });

              if (!response.ok) {
                console.error(`Create comment HTTP error: ${response.status} ${response.statusText}`);
                const text = await response.text();
                console.error(`Response body: ${text}`);
                return;
              }

              const result = await response.json();
              console.log(`Create comment result:`, JSON.stringify(result, null, 2));

              if (result.errors) {
                console.error(`GraphQL errors:`, JSON.stringify(result.errors, null, 2));
              }

              if (result.data?.commentCreate?.success) {
                console.log(`Successfully synced comment to ${linearIssue.identifier}`);
              } else {
                console.error(`Failed to create comment. Success: ${result.data?.commentCreate?.success}`);
              }

            } catch (error) {
              console.error(`Exception:`, error.message);
              console.error(error.stack);
            }
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
