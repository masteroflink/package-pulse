name: Sync GitHub to Linear

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

jobs:
  create-linear-issue:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Create Linear Issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.issue.title;
            const body = context.payload.issue.body || '';
            const githubUrl = context.payload.issue.html_url;
            const issueNumber = context.payload.issue.number;

            const labels = context.payload.issue.labels || [];
            const labelIds = [];

            for (const label of labels) {
              console.log(`Processing label: ${label.name}`);

              try {
                // Search for label using containsIgnoreCase for case-insensitive match
                const searchQuery = `{
                  issueLabels(filter: { name: { containsIgnoreCase: "${label.name}" } }) {
                    nodes { id name }
                  }
                }`;

                const searchResponse = await fetch('https://api.linear.app/graphql', {
                  method: 'POST',
                  headers: {
                    'Authorization': process.env.LINEAR_API_KEY,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ query: searchQuery })
                });

                if (!searchResponse.ok) {
                  console.error(`Label search HTTP error: ${searchResponse.status} ${searchResponse.statusText}`);
                  continue;
                }

                const searchResult = await searchResponse.json();
                console.log(`Label search result for ${label.name}:`, JSON.stringify(searchResult, null, 2));

                // Find exact match (case-insensitive)
                const existingLabel = searchResult.data?.issueLabels?.nodes?.find(
                  l => l.name.toLowerCase() === label.name.toLowerCase()
                );

                if (existingLabel) {
                  labelIds.push(existingLabel.id);
                  console.log(`Found existing label "${existingLabel.name}" with ID: ${existingLabel.id}`);
                  continue;
                }

                // Create the label if not found
                console.log(`Label ${label.name} not found, creating...`);
                const color = label.color ? `#${label.color}` : '#888888';
                const createLabelQuery = `
                  mutation {
                    issueLabelCreate(input: {
                      teamId: "${process.env.LINEAR_TEAM_ID}"
                      name: "${label.name}"
                      color: "${color}"
                    }) {
                      success
                      issueLabel { id name }
                    }
                  }
                `;

                const createResponse = await fetch('https://api.linear.app/graphql', {
                  method: 'POST',
                  headers: {
                    'Authorization': process.env.LINEAR_API_KEY,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ query: createLabelQuery })
                });

                if (!createResponse.ok) {
                  console.error(`Create label HTTP error: ${createResponse.status}`);
                  continue;
                }

                const createResult = await createResponse.json();
                console.log(`Create label result for ${label.name}:`, JSON.stringify(createResult, null, 2));

                if (createResult.data?.issueLabelCreate?.success) {
                  const labelId = createResult.data.issueLabelCreate.issueLabel.id;
                  labelIds.push(labelId);
                  console.log(`Created label ${label.name} with ID: ${labelId}`);
                } else {
                  console.error(`Failed to create label ${label.name}:`, JSON.stringify(createResult, null, 2));
                }

              } catch (error) {
                console.error(`Exception processing label ${label.name}:`, error.message);
              }
            }

            console.log(`Final labelIds array: ${JSON.stringify(labelIds)}`);

            const input = {
              teamId: process.env.LINEAR_TEAM_ID,
              projectId: process.env.LINEAR_PROJECT_ID,
              title: title,
              description: `${body}\n\n---\n[GitHub Issue #${issueNumber}](${githubUrl})`
            };

            if (labelIds.length > 0) {
              input.labelIds = labelIds;
            }

            console.log(`Creating Linear issue with input:`, JSON.stringify(input, null, 2));

            try {
              const createQuery = `
                mutation CreateIssue($input: IssueCreateInput!) {
                  issueCreate(input: $input) {
                    success
                    issue {
                      id
                      identifier
                      url
                    }
                  }
                }
              `;

              const response = await fetch('https://api.linear.app/graphql', {
                method: 'POST',
                headers: {
                  'Authorization': process.env.LINEAR_API_KEY,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: createQuery, variables: { input } })
              });

              if (!response.ok) {
                console.error(`Create issue HTTP error: ${response.status} ${response.statusText}`);
                core.setFailed('HTTP error creating Linear issue');
                return;
              }

              const result = await response.json();
              console.log(`Create issue result:`, JSON.stringify(result, null, 2));

              if (result.errors) {
                console.error(`GraphQL errors:`, JSON.stringify(result.errors, null, 2));
                core.setFailed('GraphQL error creating Linear issue');
                return;
              }

              if (result.data?.issueCreate?.success) {
                const issue = result.data.issueCreate.issue;
                console.log(`Successfully created Linear issue: ${issue.identifier} - ${issue.url}`);
              } else {
                console.error(`issueCreate returned success: false`);
                core.setFailed('Failed to create Linear issue');
              }

            } catch (error) {
              console.error(`Exception creating issue:`, error.message);
              core.setFailed(`Exception: ${error.message}`);
            }
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_TEAM_ID: ${{ secrets.LINEAR_TEAM_ID }}
          LINEAR_PROJECT_ID: ${{ secrets.LINEAR_PROJECT_ID }}

  sync-label-to-linear:
    needs: [create-linear-issue]
    if: always() && github.event_name == 'issues' && github.event.action == 'labeled'
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Linear issue to be searchable
        run: sleep 5

      - name: Sync Label to Linear
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            const label = context.payload.label;

            console.log(`Syncing label "${label.name}" for issue #${issueNumber}`);

            try {
              const searchQuery = `{
                issues(filter: { description: { contains: "GitHub Issue #${issueNumber}]" } }) {
                  nodes { id identifier }
                }
              }`;

              const searchResponse = await fetch('https://api.linear.app/graphql', {
                method: 'POST',
                headers: {
                  'Authorization': process.env.LINEAR_API_KEY,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: searchQuery })
              });

              if (!searchResponse.ok) {
                console.error(`Issue search HTTP error: ${searchResponse.status} ${searchResponse.statusText}`);
                return;
              }

              const searchResult = await searchResponse.json();
              console.log(`Issue search result:`, JSON.stringify(searchResult, null, 2));

              const linearIssue = searchResult.data?.issues?.nodes?.[0];

              if (!linearIssue) {
                console.log('No linked Linear issue found - label was likely already added during issue creation');
                return;
              }

              console.log(`Found linked Linear issue: ${linearIssue.identifier}`);

              // Search for label using containsIgnoreCase for case-insensitive match
              const labelSearchQuery = `{
                issueLabels(filter: { name: { containsIgnoreCase: "${label.name}" } }) {
                  nodes { id name }
                }
              }`;

              const labelSearchResponse = await fetch('https://api.linear.app/graphql', {
                method: 'POST',
                headers: {
                  'Authorization': process.env.LINEAR_API_KEY,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: labelSearchQuery })
              });

              if (!labelSearchResponse.ok) {
                console.error(`Label search HTTP error: ${labelSearchResponse.status}`);
                return;
              }

              const labelSearchResult = await labelSearchResponse.json();
              console.log(`Label search result:`, JSON.stringify(labelSearchResult, null, 2));

              // Find exact match (case-insensitive)
              let existingLabel = labelSearchResult.data?.issueLabels?.nodes?.find(
                l => l.name.toLowerCase() === label.name.toLowerCase()
              );

              let labelId;

              if (existingLabel) {
                labelId = existingLabel.id;
                console.log(`Found existing label "${existingLabel.name}" with ID: ${labelId}`);
              } else {
                console.log(`Label "${label.name}" not found, creating...`);
                const color = label.color ? `#${label.color}` : '#888888';

                const createLabelQuery = `
                  mutation {
                    issueLabelCreate(input: {
                      teamId: "${process.env.LINEAR_TEAM_ID}"
                      name: "${label.name}"
                      color: "${color}"
                    }) {
                      success
                      issueLabel { id name }
                    }
                  }
                `;

                const createResponse = await fetch('https://api.linear.app/graphql', {
                  method: 'POST',
                  headers: {
                    'Authorization': process.env.LINEAR_API_KEY,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ query: createLabelQuery })
                });

                if (!createResponse.ok) {
                  console.error(`Create label HTTP error: ${createResponse.status}`);
                  return;
                }

                const createResult = await createResponse.json();
                console.log(`Create label result:`, JSON.stringify(createResult, null, 2));

                if (createResult.data?.issueLabelCreate?.success) {
                  labelId = createResult.data.issueLabelCreate.issueLabel.id;
                  console.log(`Created label with ID: ${labelId}`);
                } else {
                  console.error(`Failed to create label:`, JSON.stringify(createResult, null, 2));
                  return;
                }
              }

              if (labelId) {
                console.log(`Adding label ${labelId} to issue ${linearIssue.id}`);

                const addLabelQuery = `
                  mutation {
                    issueAddLabel(id: "${linearIssue.id}", labelId: "${labelId}") {
                      success
                    }
                  }
                `;

                const addResponse = await fetch('https://api.linear.app/graphql', {
                  method: 'POST',
                  headers: {
                    'Authorization': process.env.LINEAR_API_KEY,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ query: addLabelQuery })
                });

                if (!addResponse.ok) {
                  console.error(`Add label HTTP error: ${addResponse.status}`);
                  return;
                }

                const addResult = await addResponse.json();
                console.log(`Add label result:`, JSON.stringify(addResult, null, 2));

                if (addResult.data?.issueAddLabel?.success) {
                  console.log(`Successfully added label "${label.name}" to ${linearIssue.identifier}`);
                } else {
                  console.error(`Failed to add label:`, JSON.stringify(addResult, null, 2));
                }
              }

            } catch (error) {
              console.error(`Exception:`, error.message);
            }
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_TEAM_ID: ${{ secrets.LINEAR_TEAM_ID }}

  sync-comment-to-linear:
    if: github.event_name == 'issue_comment' && github.event.action == 'created'
    runs-on: ubuntu-latest
    steps:
      - name: Sync Comment to Linear
        uses: actions/github-script@v7
        with:
          script: |
            if (context.payload.comment.user.type === 'Bot') {
              console.log('Skipping bot comment');
              return;
            }

            const issueNumber = context.payload.issue.number;
            const commentBody = context.payload.comment.body;
            const commenter = context.payload.comment.user.login;

            console.log(`Syncing comment from @${commenter} on issue #${issueNumber}`);

            try {
              const searchQuery = `{
                issues(filter: { description: { contains: "GitHub Issue #${issueNumber}]" } }) {
                  nodes { id identifier }
                }
              }`;

              const searchResponse = await fetch('https://api.linear.app/graphql', {
                method: 'POST',
                headers: {
                  'Authorization': process.env.LINEAR_API_KEY,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: searchQuery })
              });

              if (!searchResponse.ok) {
                console.error(`Issue search HTTP error: ${searchResponse.status}`);
                return;
              }

              const searchResult = await searchResponse.json();
              const linearIssue = searchResult.data?.issues?.nodes?.[0];

              if (!linearIssue) {
                console.log('No linked Linear issue found');
                return;
              }

              console.log(`Found linked Linear issue: ${linearIssue.identifier}`);

              const createCommentQuery = `
                mutation CreateComment($input: CommentCreateInput!) {
                  commentCreate(input: $input) {
                    success
                    comment { id }
                  }
                }
              `;

              const response = await fetch('https://api.linear.app/graphql', {
                method: 'POST',
                headers: {
                  'Authorization': process.env.LINEAR_API_KEY,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  query: createCommentQuery,
                  variables: {
                    input: {
                      issueId: linearIssue.id,
                      body: `**From GitHub - @${commenter}**\n\n${commentBody}`
                    }
                  }
                })
              });

              if (!response.ok) {
                console.error(`Create comment HTTP error: ${response.status}`);
                return;
              }

              const result = await response.json();
              console.log(`Create comment result:`, JSON.stringify(result, null, 2));

              if (result.data?.commentCreate?.success) {
                console.log(`Successfully synced comment to ${linearIssue.identifier}`);
              } else {
                console.error(`Failed to create comment:`, JSON.stringify(result, null, 2));
              }

            } catch (error) {
              console.error(`Exception:`, error.message);
            }
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
