name: Sync GitHub Issues to Linear

on:
  issues:
    types: [opened]

jobs:
  create-linear-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Create Linear Issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.issue.title.replace(/"/g, '\\"');
            const body = (context.payload.issue.body || '').replace(/"/g, '\\"').replace(/\n/g, '\\n');
            const githubUrl = context.payload.issue.html_url;

            const query = `
              mutation {
                issueCreate(input: {
                  teamId: "${process.env.LINEAR_TEAM_ID}"
                  projectId: "${process.env.LINEAR_PROJECT_ID}"
                  title: "${title}"
                  description: "${body}\\n\\n---\\n[GitHub Issue](${githubUrl})"
                }) {
                  success
                  issue {
                    id
                    identifier
                    url
                  }
                }
              }
            `;

            const response = await fetch('https://api.linear.app/graphql', {
              method: 'POST',
              headers: {
                'Authorization': process.env.LINEAR_API_KEY,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ query })
            });

            const result = await response.json();

            if (result.data?.issueCreate?.success) {
              const issue = result.data.issueCreate.issue;
              console.log(`Created Linear issue: ${issue.identifier}`);
              console.log(`URL: ${issue.url}`);
            } else {
              console.error('Failed to create Linear issue:', JSON.stringify(result, null, 2));
              core.setFailed('Failed to create Linear issue');
            }
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_TEAM_ID: ${{ secrets.LINEAR_TEAM_ID }}
          LINEAR_PROJECT_ID: ${{ secrets.LINEAR_PROJECT_ID }}
